using Iql.Serialization;
using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace Iql.Tests.Tests.Serialization
{
    [TestClass]
    public class IqlSerializationTests
    {
        [TestMethod]
        public void DeserializeBinaryWithPropertyExpression()
        {
            var json = @"{""Left"":{""PropertyName"":""CreatedByUserId"",""IsIqlExpression"":true,""Kind"":30,""ReturnType"":1,""Parent"":{""EntityTypeName"":null,""Value"":"""",""VariableName"":""entity"",""IsIqlExpression"":true,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Right"":{""Value"":""e5db3128-2939-4720-bf7f-5118c13ea107"",""InferredReturnType"":4,""IsIqlExpression"":true,""Kind"":26,""ReturnType"":4,""Parent"":null},""IsIqlExpression"":true,""Key"":""RelationshipSingle"",""Kind"":10,""ReturnType"":1,""Parent"":null}";
            var iql = IqlJsonDeserializer.DeserializeJson(json);
            Assert.AreEqual("CreatedByUserId", ((IqlPropertyExpression)((IqlBinaryExpression)iql).Left).PropertyName);
        }

        [TestMethod]
        public void DeserializeIql()
        {
            var json =
                @"{""DataSet"":{""Name"":""Incidents"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Skip"":0,""Take"":12,""Expands"":[{""NavigationProperty"":{""PropertyName"":""Location"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""Locations"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""Category"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""IncidentCategories"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""InjuryClassification"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""InjuryClassifications"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""ReportedBy"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""Users"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""Location"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""Locations"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""Category"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""IncidentCategories"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""InjuryClassification"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""InjuryClassifications"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""ReportedBy"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""Users"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""Location"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""Locations"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""Category"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""IncidentCategories"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""InjuryClassification"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""InjuryClassifications"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null},{""NavigationProperty"":{""PropertyName"":""ReportedBy"",""Kind"":30,""ReturnType"":1,""Parent"":{""Value"":null,""VariableName"":null,""Kind"":28,""ReturnType"":1,""Parent"":null}},""Query"":{""DataSet"":{""Name"":""Users"",""Kind"":50,""ReturnType"":2,""Parent"":null},""Filter"":null,""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null},""Count"":false,""Kind"":48,""ReturnType"":2,""Parent"":null}],""Filter"":{""Left"":{""Left"":{""Left"":{""Left"":{""Left"":{""Left"":{""Left"":{""Left"":{""Value"":{""Value"":""abcd"",""InferredReturnType"":4,""Kind"":26,""ReturnType"":4,""Parent"":null},""Kind"":31,""ReturnType"":7,""Parent"":{""PropertyName"":""ReportedById"",""Kind"":30,""ReturnType"":4,""Parent"":{""Value"":"""",""VariableName"":""root"",""Kind"":28,""ReturnType"":1,""Parent"":null}}},""Right"":{""Value"":{""Value"":""abcd"",""InferredReturnType"":4,""Kind"":26,""ReturnType"":4,""Parent"":null},""Kind"":31,""ReturnType"":7,""Parent"":{""PropertyName"":""CreatedByUserId"",""Kind"":30,""ReturnType"":4,""Parent"":{""Value"":"""",""VariableName"":""root"",""Kind"":28,""ReturnType"":1,""Parent"":null}}},""Kind"":4,""ReturnType"":1,""Parent"":null},""Right"":{""Value"":{""Value"":""abcd"",""InferredReturnType"":4,""Kind"":26,""ReturnType"":4,""Parent"":null},""Kind"":31,""ReturnType"":7,""Parent"":{""PropertyName"":""Description"",""Kind"":30,""ReturnType"":4,""Parent"":{""Value"":"""",""VariableName"":""root"",""Kind"":28,""ReturnType"":1,""Parent"":null}}},""Kind"":4,""ReturnType"":1,""Parent"":null},""Right"":{""Value"":{""Value"":""abcd"",""InferredReturnType"":4,""Kind"":26,""ReturnType"":4,""Parent"":null},""Kind"":31,""ReturnType"":7,""Parent"":{""PropertyName"":""FurtherDetails"",""Kind"":30,""ReturnType"":4,""Parent"":{""Value"":"""",""VariableName"":""root"",""Kind"":28,""ReturnType"":1,""Parent"":null}}},""Kind"":4,""ReturnType"":1,""Parent"":null},""Right"":{""Value"":{""Value"":""abcd"",""InferredReturnType"":4,""Kind"":26,""ReturnType"":4,""Parent"":null},""Kind"":31,""ReturnType"":7,""Parent"":{""PropertyName"":""Title"",""Kind"":30,""ReturnType"":4,""Parent"":{""PropertyName"":""Location"",""Kind"":30,""ReturnType"":4,""Parent"":{""Value"":"""",""VariableName"":""root"",""Kind"":28,""ReturnType"":1,""Parent"":null}}}},""Kind"":4,""ReturnType"":1,""Parent"":null},""Right"":{""Value"":{""Value"":""abcd"",""InferredReturnType"":4,""Kind"":26,""ReturnType"":4,""Parent"":null},""Kind"":31,""ReturnType"":7,""Parent"":{""PropertyName"":""FullName"",""Kind"":30,""ReturnType"":4,""Parent"":{""PropertyName"":""ReportedBy"",""Kind"":30,""ReturnType"":4,""Parent"":{""Value"":"""",""VariableName"":""root"",""Kind"":28,""ReturnType"":1,""Parent"":null}}}},""Kind"":4,""ReturnType"":1,""Parent"":null},""Right"":{""Value"":{""Value"":""abcd"",""InferredReturnType"":4,""Kind"":26,""ReturnType"":4,""Parent"":null},""Kind"":31,""ReturnType"":7,""Parent"":{""PropertyName"":""Title"",""Kind"":30,""ReturnType"":4,""Parent"":{""PropertyName"":""Category"",""Kind"":30,""ReturnType"":4,""Parent"":{""Value"":"""",""VariableName"":""root"",""Kind"":28,""ReturnType"":1,""Parent"":null}}}},""Kind"":4,""ReturnType"":1,""Parent"":null},""Right"":{""Value"":{""Value"":""abcd"",""InferredReturnType"":4,""Kind"":26,""ReturnType"":4,""Parent"":null},""Kind"":31,""ReturnType"":7,""Parent"":{""PropertyName"":""Title"",""Kind"":30,""ReturnType"":4,""Parent"":{""PropertyName"":""InjuryClassification"",""Kind"":30,""ReturnType"":4,""Parent"":{""Value"":"""",""VariableName"":""root"",""Kind"":28,""ReturnType"":1,""Parent"":null}}}},""Kind"":4,""ReturnType"":1,""Parent"":null},""Right"":{""Value"":{""Value"":""abcd"",""InferredReturnType"":4,""Kind"":26,""ReturnType"":4,""Parent"":null},""Kind"":31,""ReturnType"":7,""Parent"":{""PropertyName"":""FullName"",""Kind"":30,""ReturnType"":4,""Parent"":{""PropertyName"":""CreatedByUser"",""Kind"":30,""ReturnType"":4,""Parent"":{""Value"":"""",""VariableName"":""root"",""Kind"":28,""ReturnType"":1,""Parent"":null}}}},""Kind"":4,""ReturnType"":1,""Parent"":null},""WithKey"":null,""Kind"":49,""ReturnType"":3,""Parent"":null}";
            var iql = IqlJsonDeserializer.DeserializeJsonAs<IqlDataSetQueryExpression>(json);
            Assert.IsNotNull(iql);
            Assert.AreEqual(typeof(IqlDataSetQueryExpression), iql.GetType());
        }
    }
}